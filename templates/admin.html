<!DOCTYPE html>
<html lang="bs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin • Dozvole pristupa</title>
  <style>
    :root{
      --bg:#0e1517; --card:#172125; --muted:#8fb2be; --text:#e9f1f3;
      --brand:#3d7d66; --brand-2:#2e5a4e; --danger:#c94f4f; --border:#243137;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0d1416,#0a1012);color:var(--text);
         font: 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',sans-serif;}
    header{position:sticky;top:0;z-index:5;background:var(--brand);
           padding:.9rem 1.1rem;display:flex;gap:12px;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:1.15rem;letter-spacing:.4px}
    main{max-width:1000px;margin:24px auto;padding:0 16px;display:grid;gap:16px;grid-template-columns: 1fr 2fr;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .card h2{margin:.2rem 0 .6rem;font-size:1.05rem}
    label{display:block;font-weight:600;margin:.25rem 0 .4rem;color:var(--muted)}
    input[type="email"], input[type="text"]{
      width:100%;padding:.7rem .85rem;border-radius:10px;border:1px solid var(--border);background:#0f1618;color:var(--text);
      outline:none;transition:border .15s, box-shadow .15s;
    }
    input:focus{border-color:#3e7a69; box-shadow:0 0 0 3px rgba(61,125,102,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:0;border-radius:10px;padding:.6rem .85rem;background:var(--brand);color:#fff;cursor:pointer;font-weight:600}
    .btn:hover{background:var(--brand-2)}
    .btn.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
    .btn.danger{background:var(--danger)}
    .muted{color:var(--muted);font-size:.92rem}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:8px}
    .search{flex:1}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.55rem .6rem;border-bottom:1px solid var(--border);vertical-align:middle}
    th{font-size:.9rem;text-align:left;color:var(--muted)}
    tr:hover{background:#121b1e}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:.85rem;padding:.25rem .5rem;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .status{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0f1618;border:1px solid var(--border);color:var(--text);
            padding:.6rem .9rem;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.35);display:none}
    .status.show{display:block}
  </style>
</head>
<body>
  <header>
    <h1>Admin • Dozvole pristupa</h1>
    <div class="row">
      <span class="pill">Status: <b id="status-pill">offline</b></span>
      <form class="row" method="post" action="/odjava">
        <button class="btn ghost" title="Odjava admina">Odjavi se</button>
      </form>
    </div>
  </header>

  <main>
    <!-- lijevi panel: ručni unos -->
    <section class="card">
      <h2>Dodaj e-mail</h2>
      <label for="single-email">E-mail</label>
      <div class="row">
        <input id="single-email" type="email" placeholder="ucenik1@example.com" />
        <button id="btn-add-one" class="btn">Dodaj</button>
      </div>
      <p class="muted" style="margin-top:.5rem">Unosi jedan e-mail. Duplicirani se automatski preskaču.</p>
    </section>

    <!-- desni panel: tabela -->
    <section class="card">
      <div class="toolbar">
        <div class="row search">
          <input id="search" type="text" placeholder="Pretraga e-mailova..." />
        </div>
        <div class="row">
          <button id="btn-refresh" class="btn ghost" title="Osvježi listu">Osvježi</button>
          <button id="btn-delete" class="btn danger" title="Obriši označene">Obriši označene</button>
        </div>
      </div>

      <div class="muted" style="margin-bottom:6px">
        Ukupno: <b id="count">0</b> e-mailova
      </div>

      <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:36px;"><input id="check-all" type="checkbox" title="Označi sve"></th>
              <th>E-mail</th>
            </tr>
          </thead>
          <tbody id="rows">
            <!-- dinamika -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="status">OK</div>

  <script>
  // --- helperi ---
  const $ = s => document.querySelector(s);
  const toast = (msg, ms=1600) => {
    const el = $("#toast");
    el.textContent = msg;
    el.classList.add("show");
    setTimeout(()=> el.classList.remove("show"), ms);
  };
  const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/i;

  async function api(url, data=null){
    const opts = { credentials:"include" };
    if(data){
      opts.method = "POST";
      opts.headers = {"Content-Type":"application/json"};
      opts.body = JSON.stringify(data);
    }
    const r = await fetch(url, opts);
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  // stanje
  let allEmails = [];

  function renderTable(){
    const q = ($("#search").value || "").trim().toLowerCase();
    const list = q ? allEmails.filter(e => e.toLowerCase().includes(q)) : allEmails.slice();
    list.sort((a,b)=> a.localeCompare(b));
    $("#count").textContent = allEmails.length;

    const tbody = $("#rows");
    tbody.innerHTML = "";
    for(const e of list){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="row-check" data-email="${e}"></td>
        <td>${e}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function loadEmails(){
    try{
      $("#status-pill").textContent = "učitavam…";
      const data = await api("/admin/api/emails");   // { emails: [...] }
      allEmails = Array.isArray(data.emails) ? data.emails : [];
      $("#status-pill").textContent = "online";
      renderTable();
    }catch(err){
      $("#status-pill").textContent = "greška";
      toast("Greška pri učitavanju liste");
    }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    loadEmails();

    $("#search").addEventListener("input", renderTable);
    $("#btn-refresh").addEventListener("click", (e)=>{e.preventDefault(); loadEmails();});

    // označi sve
    $("#check-all").addEventListener("change", (e)=>{
      document.querySelectorAll(".row-check").forEach(cb => cb.checked = e.target.checked);
    });

    // dodavanje jednog (klik)
    $("#btn-add-one").addEventListener("click", async (e)=>{
      e.preventDefault();
      const val = $("#single-email").value.trim();
      if(!emailRe.test(val)){ toast("Unesi ispravan e-mail"); return; }
      try{
        await api("/admin/api/add", {email: val});
        $("#single-email").value = "";
        toast("Dodano");
        loadEmails();
      }catch(err){ toast("Greška pri dodavanju"); }
    });

    // dodavanje Enter-om
    $("#single-email").addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ e.preventDefault(); $("#btn-add-one").click(); }
    });

    // brisanje označenih
    $("#btn-delete").addEventListener("click", async (e)=>{
      e.preventDefault();
      const emails = Array.from(document.querySelectorAll(".row-check:checked")).map(cb=>cb.dataset.email);
      if(!emails.length){ toast("Nije ništa označeno"); return; }
      if(!confirm(`Obriši ${emails.length} označenih?`)) return;
      try{
        await api("/admin/api/delete", {emails});
        toast("Obrisano");
        loadEmails();
      }catch(err){ toast("Greška pri brisanju"); }
    });
  });
  </script>
</body>
</html>
