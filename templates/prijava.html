<!DOCTYPE html>
<html lang="bs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prijava • MAT-BOT</title>
  <meta name="color-scheme" content="light dark">

  <style>
    :root{
      --bg1:#eef5ff; --bg2:#f7fbff;
      --card:#ffffff; --border:#e6eef7; --text:#1e293b;
      --muted:#64748b; --accent:#3d7d66; --accent-2:#2f5c4e;
      --danger:#c94f4f; --warning:#d97706;
      --shadow:0 10px 35px rgba(0,0,0,.08);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg1:#0d1416; --bg2:#0a0f11; --card:#1b2327; --border:#22323a; --text:#e8f3f6; --muted:#94a3b8; --accent:#2f5c4e; --accent-2:#274a40; --shadow:0 10px 35px rgba(0,0,0,.35); }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      display:grid; place-items:center;
      padding:24px;
    }

    .wrap{width:100%; max-width: 420px;}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      box-shadow:var(--shadow); padding:22px 20px;
    }
    .brand{
      display:flex; align-items:center; gap:.75rem; justify-content:center; margin-bottom:.5rem;
    }
    .brand .logo{
      width:42px;height:42px;border-radius:10px; display:grid; place-items:center;
      background:linear-gradient(135deg,#4caf50 0%, #3d7d66 100%); color:#fff; font-weight:800;
      box-shadow:0 6px 18px rgba(61,125,102,.35);
    }
    h1{font-size:1.25rem; margin:.25rem 0 .75rem; text-align:center}
    p.sub{margin:.25rem 0 1rem; text-align:center; color:var(--muted); font-size:.95rem}

    form{display:flex; flex-direction:column; gap:.9rem}
    label{font-weight:600; font-size:.95rem}
    .input{
      display:flex; align-items:center; border:2px solid var(--border); border-radius:12px; background:#fff0;
      padding:10px 12px; transition:border-color .15s ease, box-shadow .15s ease;
    }
    .input:focus-within{border-color:var(--accent); box-shadow:0 0 0 3px rgba(61,125,102,.18)}
    input[type="email"], input[type="password"], input[type="text"]{
      border:none; outline:none; flex:1; font-size:1rem; background:transparent; color:inherit; min-width:0;
    }
    .toggle{
      background:transparent; border:none; color:var(--muted); cursor:pointer; font-size:.95rem; padding:4px 6px;
    }

    .row{display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap}
    .muted{color:var(--muted); font-size:.9rem}

    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:700;
      padding:.9rem 1rem; border-radius:12px; font-size:1rem;
      background:var(--accent); color:#fff; transition:transform .05s ease, background .15s ease;
      width:100%;
    }
    .btn:hover{background:var(--accent-2)}
    .btn:active{transform: translateY(1px)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}

    .note{font-size:.85rem; color:var(--muted); text-align:center; margin-top:.75rem}
    .err, .ok{
      border-radius:10px; padding:.65rem .75rem; font-size:.95rem; line-height:1.4;
      margin:.5rem 0 0;
    }
    .err{background:#fee2e2; color:#7f1d1d; border:1px solid #fecaca}
    .ok{background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0}

    .footer{
      margin-top:12px; color:var(--muted); font-size:.85rem; text-align:center;
    }

    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:3px solid rgba(255,255,255,.35); border-top-color:#fff; display:inline-block;
      animation:spin .8s linear infinite; vertical-align:-3px; margin-right:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

  <div class="wrap">
    <div class="card">
      <div class="brand">
        <div class="logo">M</div>
        <div>
          <h1>Prijava na MAT-BOT</h1>
          <p class="sub">Unesi svoj e-mail (identifikator) i pristupni kod</p>
        </div>
      </div>

      <!-- Noscript fallback: klasičan POST submit na /prijava -->
      <form id="loginForm" method="POST" action="/prijava" novalidate>
        <div>
          <label for="email">Email</label>
          <div class="input">
            <input id="email" name="email" type="email" placeholder="ime.prezime@primjer.com" required autocomplete="email">
          </div>
        </div>

        <div>
          <label for="code">Pristupni kod</label>
          <div class="input">
            <input id="code" name="code" type="password" placeholder="Unesi kod" required autocomplete="current-password" minlength="4" maxlength="128">
            <button type="button" class="toggle" id="toggleCode" aria-label="Prikaži/sakrij kod">Prikaži</button>
          </div>
        </div>

        <div class="row">
          <span class="muted">
            Savjet: zapamti email na ovom uređaju
          </span>
          <label class="muted" style="display:flex;align-items:center;gap:.5rem;cursor:pointer;">
            <input type="checkbox" id="rememberEmail">
            Zapamti email
          </label>
        </div>

        <button class="btn" id="submitBtn" type="submit">
          Prijavi se
        </button>

        <div id="msg" role="alert" style="display:none"></div>

        <p class="note">Ako ne znaš kod, obrati se nastavniku.</p>
      </form>

      <div class="footer">© <span id="year"></span> Matematičari</div>
    </div>
  </div>

  <script>
    // Utility
    const $ = (sel, root=document)=>root.querySelector(sel);
    const $$ = (sel, root=document)=>[...root.querySelectorAll(sel)];

    const form = $("#loginForm");
    const emailEl = $("#email");
    const codeEl = $("#code");
    const rememberEl = $("#rememberEmail");
    const toggleCode = $("#toggleCode");
    const submitBtn = $("#submitBtn");
    const msg = $("#msg");

    // Init: set year & restore remembered email
    $("#year").textContent = new Date().getFullYear();
    try {
      const saved = localStorage.getItem("matbot_email");
      if(saved) { emailEl.value = saved; rememberEl.checked = true; }
    } catch(_) {}

    // Show/Hide code
    toggleCode.addEventListener("click", ()=>{
      const isPass = codeEl.type === "password";
      codeEl.type = isPass ? "text" : "password";
      toggleCode.textContent = isPass ? "Sakrij" : "Prikaži";
      codeEl.focus();
    });

    // Client validation helper
    function validate(){
      msg.style.display = "none";
      msg.className = "";
      if(!emailEl.value.trim()){
        showErr("Unesi email.");
        emailEl.focus();
        return false;
      }
      // rudimentarna provjera forme email-a
      if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(emailEl.value.trim())){
        showErr("Email format nije ispravan.");
        emailEl.focus();
        return false;
      }
      if(!codeEl.value.trim()){
        showErr("Unesi pristupni kod.");
        codeEl.focus();
        return false;
      }
      return true;
    }

    function showErr(text){
      msg.textContent = text;
      msg.className = "err";
      msg.style.display = "block";
    }
    function showOk(text){
      msg.textContent = text;
      msg.className = "ok";
      msg.style.display = "block";
    }

    // Progressive enhancement: hijack submit i uradi fetch
    form.addEventListener("submit", async (e)=>{
      // Ako nema JS, browser će ionako uraditi klasičan POST; sa JS-om sprječavamo default
      e.preventDefault();
      if(!validate()) return;

      // Remember email
      try {
        if(rememberEl.checked) localStorage.setItem("matbot_email", emailEl.value.trim());
        else localStorage.removeItem("matbot_email");
      } catch(_){}

      // Disable UI
      submitBtn.disabled = true;
      const oldLabel = submitBtn.textContent;
      submitBtn.innerHTML = '<span class="spinner"></span>Prijava...';

      // Pripremi form data
      const fd = new FormData();
      fd.append("email", emailEl.value.trim().toLowerCase());
      fd.append("code", codeEl.value);

      try{
        const res = await fetch(form.action, {
          method: "POST",
          body: fd,
          credentials: "include"  // važno da bi se HttpOnly cookie postavio
        });

        // Mapa najčešćih odgovora backend-a
        if(res.status === 200 && res.redirected){
          // backend je redirectovao na / (a fetch je pratio)
          window.location.href = res.url || "/";
          return;
        }
        if(res.status === 200){
          // često nakon uspjeha backend svakako servira /; ipak forsiraj navigaciju
          window.location.href = "/";
          return;
        }
        if(res.status === 401){
          showErr("Pogrešan pristupni kod.");
        } else if(res.status === 403){
          showErr("Ovaj email nije na listi dozvoljenih.");
        } else if(res.status === 429){
          showErr("Previše pokušaja. Pokušaj ponovo za nekoliko minuta.");
        } else if(res.status === 400){
          showErr("Nedostaju podaci. Provjeri unos.");
        } else {
          showErr("Greška pri prijavi. Pokušaj ponovo.");
        }

      } catch(err){
        showErr("Mrežna greška. Provjeri vezu i pokušaj ponovo.");
      } finally{
        submitBtn.disabled = false;
        submitBtn.textContent = oldLabel;
      }
    });
  </script>
</body>
</html>
