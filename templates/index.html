<!DOCTYPE html>
<html lang="bs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAT-BOT</title>

  <script>
    MathJax = { tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] }, svg: { fontCache: "global" } };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>

  <style>
  /* (isti stil kao ranije koji smo ti poslali ‚Äì skraƒáeno zbog prostora)
     Ostavljam kljuƒçne dijelove: user bubble bez zelenog ruba, sticky typing, centriranje itd. */
  :root{--accent-bot:#4caf50;--accent-user:#05afc5;--bubble-bg:#eaf7e8;--bubble-text:#1a1a1a;--page-bg:#f0f4ff;--card-bg:#fff;}
  body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:var(--page-bg);color:#333;margin:0;padding:100px 0 0}
  header{background:#3d7d66;color:#fff;padding:1rem;display:flex;align-items:center;justify-content:center;position:fixed;top:0;left:0;right:0;z-index:1000}
  main{max-width:800px;margin:0 auto;padding:2rem;display:flex;flex-direction:column;gap:1.5rem;background:var(--card-bg);border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.08)}
  .chat-message{display:flex;width:100%;word-break:break-word}.user-message{justify-content:flex-end}.bot-message{justify-content:flex-start}
  .formatted-bot-response,.formatted-bot-response.user-style{padding:.9rem 1.1rem;border-radius:14px;font-size:1rem;line-height:1.75;box-shadow:0 1px 4px rgba(0,0,0,.05);white-space:pre-wrap;max-width:75%;background:var(--bubble-bg);color:var(--bubble-text)}
  .formatted-bot-response{border-left:4px solid var(--accent-bot);margin:.35rem 0}
  .formatted-bot-response.user-style{background:#c8ebf0;border-right:4px solid var(--accent-user);border-left:0!important;margin:.35rem 0 .35rem auto;max-width:60%}
  #chat-container{display:flex;flex-direction:column;gap:.75rem;max-height:60vh;overflow-y:auto;scroll-behavior:smooth;padding-bottom:.5rem}
  .typing-indicator{position:sticky;bottom:0;align-self:flex-start;font-style:italic;font-size:1rem;padding:.5rem .75rem;color:#444;background:#fff2c2;border-left:4px solid #ffb84d;border-radius:8px;margin:.25rem 0 0;max-width:320px;display:none;z-index:2}
  .typing-indicator::after{content:'...';animation:dots 1s steps(3,end) infinite}@keyframes dots{0%{content:''}33%{content:'.'}66%{content:'..'}100%{content:'...'}}
  textarea{width:100%;min-height:120px;padding:1rem;font-size:1.1rem;border-radius:12px;border:2px solid #50e3c2;background:#f8fafd;outline:none;resize:vertical}
  textarea:focus{border-color:#3d7d66;box-shadow:0 4px 14px rgba(0,0,0,.08)}
  </style>
</head>
<body>
  <header><div class="title-container">MAT-BOT</div></header>

  <main>
    <div id="chat-container">
      {% if history %}
        {% for message in history %}
        <div class="qa-pair">
          <div class="chat-message user-message"><div class="formatted-bot-response user-style"><p>{{ message.user }}</p></div></div>
          <div class="chat-message bot-message"><div class="formatted-bot-response">{{ message.bot|safe }}</div></div>
        </div>
        {% endfor %}
      {% endif %}
      <div id="typing" class="typing-indicator">ü§ñ MAT-BOT pi≈°e odgovor</div>
    </div>

    <form id="ask-form" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="history_json" id="history_json_main" value='{{ history|tojson|safe }}'>
      <div id="razred-wrapper" {% if razred %}style="display: none;"{% endif %}>
        <label for="razred"><strong>Koji si razred?</strong></label>
        <select name="razred" id="razred" required>
          <option value="">-- Odaberi razred --</option>
          <option value="5" {% if razred == "5" %}selected{% endif %}>5. razred</option>
          <option value="6" {% if razred == "6" %}selected{% endif %}>6. razred</option>
          <option value="7" {% if razred == "7" %}selected{% endif %}>7. razred</option>
          <option value="8" {% if razred == "8" %}selected{% endif %}>8. razred</option>
          <option value="9" {% if razred == "9" %}selected{% endif %}>9. razred</option>
        </select>
      </div>

      <label for="pitanje"><strong>Postavi mi matematiƒçko pitanje (tekst ili slika):</strong></label>
      <textarea name="pitanje" id="pitanje" placeholder="Ovdje mo≈æe≈° unijeti zadatak ili pitanje..." autofocus></textarea>

      <label for="slika"><strong>Ili uƒçitaj sliku pitanja:</strong></label>
      <input type="file" name="slika" accept="image/*" />

      <button type="submit">üìß Po≈°alji</button>
    </form>

    <form id="clear-form" method="POST" action="/clear">
      <input type="hidden" name="confirm_clear" value="1" />
      <button type="submit" style="background-color:#c94f4f;">üóëÔ∏è Oƒçisti konverzaciju</button>
    </form>
  </main>

<script>
let __matbotSubmitting = false;

function showTyping(){
  const el = document.getElementById('typing');
  if(!el) return;
  el.style.display='block';
  const chat=document.getElementById('chat-container');
  if(chat) chat.scrollTop = chat.scrollHeight;
}
function scrollToBottom(){ const chat=document.getElementById('chat-container'); if(chat) chat.scrollTop = chat.scrollHeight; }

function getCID(){
  const key='matbot_cid';
  if(!localStorage.getItem(key)){
    const cid = (crypto.randomUUID)? crypto.randomUUID() : (Date.now()+'_'+Math.random());
    localStorage.setItem(key,cid);
  }
  return localStorage.getItem(key);
}

function getTrimmedHistoryForSubmit(HIST_KEY){
  let arr=[];
  try{ arr = JSON.parse(localStorage.getItem(HIST_KEY) || '[]'); }catch(_){}
  const last5 = arr.slice(-5).map(m=>({
    user: String(m.user||'').slice(0,2000),
    bot:  String(m.bot ||'').slice(0,4000)
  }));
  return JSON.stringify(last5);
}

document.addEventListener('DOMContentLoaded', () => {
  const askForm = document.getElementById('ask-form');
  const clearForm = document.getElementById('clear-form');
  const hiddenMain = document.getElementById('history_json_main');
  const cid = getCID();
  const HIST_KEY = 'matbot_history_' + cid;
  const serverHistory = {{ history|tojson|safe }};

  // U localStorage spremi samo zadnjih 5 s poƒçetne strane
  if (Array.isArray(serverHistory) && serverHistory.length) {
    const last5 = serverHistory.slice(-5);
    localStorage.setItem(HIST_KEY, JSON.stringify(last5));
    if (hiddenMain) hiddenMain.value = JSON.stringify(last5);
  } else {
    if (hiddenMain) hiddenMain.value = getTrimmedHistoryForSubmit(HIST_KEY);
  }

  if (askForm){
    askForm.addEventListener('submit', (e)=>{
      const textarea = askForm.querySelector('textarea');
      const fileInput = askForm.querySelector('input[type="file"]');
      if ((!textarea || !textarea.value.trim()) && (!fileInput || !fileInput.files.length)){
        alert("Unesi matematiƒçko pitanje ili uƒçitaj sliku.");
        e.preventDefault(); return;
      }
      // U hidden polje ≈°aljemo samo TRIMOVANU historiju (zadnjih 5)
      if (hiddenMain) hiddenMain.value = getTrimmedHistoryForSubmit(HIST_KEY);

      showTyping();
      __matbotSubmitting = true;
      e.preventDefault();
      setTimeout(()=>askForm.submit(), 150);
    });
  }

  if (clearForm){
    clearForm.addEventListener('submit', ()=>{
      localStorage.removeItem(HIST_KEY);
    });
  }
});

window.onload = ()=> setTimeout(scrollToBottom, 150);

/* Plot funkcije (isti kao ranije) */
function transformExpression(expr){return expr.replace(/\s+/g,'').replace(/([0-9])([a-zA-Z])/g,'$1*$2').replace(/([a-zA-Z])([a-zA-Z])/g,'$1*$2').replace(/([a-zA-Z])(\d)/g,'$1*$2').replace(/(\))(\()/g,'$1*$2').replace(/(\))([a-zA-Z])/g,'$1*$2').replace(/([a-zA-Z])(\()/g,'$1*$2').replace(/(\d+|\w+)\^(\d+|\w+)/g,'Math.pow($1,$2)').replace(/(?<!\.)\b(sin|cos|tan|exp|log|sqrt|abs)\b/g,'Math.$1').replace(/\bln\b/g,'Math.log');}
function drawPlot(expression, container){const p=transformExpression(expression);const x=[],y=[];let f;try{f=new Function('x',`return ${p}`);}catch(e){return;}for(let i=-10;i<=10;i+=0.1){try{const r=f(i);x.push(i);y.push(isFinite(r)?r:null);}catch{x.push(i);y.push(null);}}const data=[{x,y,mode:'lines',line:{color:'#0077cc',width:3},name:expression}],layout={title:`Graf funkcije: y = ${expression}`,xaxis:{title:'x'},yaxis:{title:'y'},margin:{t:40},plot_bgcolor:'#fff',paper_bgcolor:'#fff'};const graphDiv=document.createElement("div");graphDiv.style="width:100%;max-width:700px;height:400px;margin-top:1rem;";container.appendChild(graphDiv);Plotly.newPlot(graphDiv,data,layout);}
document.querySelectorAll('.plot-request').forEach(plotDiv=>{let expression=plotDiv.getAttribute("data-expression");const parent=plotDiv.closest(".formatted-bot-response");if(!expression||!parent)return;if(expression.trim().startsWith("y="))expression=expression.replace(/^y\s*=\s*/i,"").trim();drawPlot(expression,parent);plotDiv.remove();});
</script>
</body>
</html>
