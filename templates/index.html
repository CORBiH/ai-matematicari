<!DOCTYPE html>
<html lang="bs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAT-BOT</title>

  <script>
    MathJax = { tex: { inlineMath: [["$", "$"], ["\\(", "\\)"]] }, svg: { fontCache: "global" } };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>

  <style>
  :root{
    --page-bg:linear-gradient(180deg,#eef5ff 0%,#f7fbff 100%);
    --card-bg:rgba(255,255,255,.94);
    --card-border:rgba(0,0,0,.06);
    --text:#1a1a1a;
    --accent-bot:#4caf50;
    --accent-user:#05afc5;
    --bubble-bg:#eaf7e8;
    --bubble-text:#1a1a1a;
    --btn-bg:#3d7d66;
    --btn-bg-hover:#2f5c4e;
    --danger:#c94f4f;
    --muted:#6b7a86;
    --typing-bg:#fff7d9;
    --typing-border:#ffb84d;
  }
  body.dark{
    --page-bg:linear-gradient(180deg,#0b1113 0%,#070b0d 100%);
    --card-bg:rgba(23,29,33,.95);
    --card-border:rgba(255,255,255,.08);
    --text:#e9f1f3;
    --bubble-bg:#1f2a2f;
    --bubble-text:#e9f1f3;
    --btn-bg:#2b5950;
    --btn-bg-hover:#234a42;
    --muted:#a9b7bf;
    --typing-bg:#2a2f18;
    --typing-border:#b28a2a;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;background:var(--page-bg);color:var(--text);margin:0;padding:100px 0 32px}

  header{position:fixed;top:0;left:0;right:0;z-index:1000;background:#3d7d66;color:#fff;padding:.9rem 1rem;display:flex;align-items:center;justify-content:center;}
  .title-container{font-size:1.85rem;font-weight:700;letter-spacing:.5px;}
  .dropdown{position:absolute;right:1rem;top:.6rem;}
  .dropdown-toggle{background:var(--btn-bg);color:#fff;border:none;padding:.55rem .9rem;font-size:1rem;border-radius:10px;cursor:pointer;}
  .dropdown-toggle:hover{background:var(--btn-bg-hover);}
  .dropdown-content{display:none;position:absolute;top:115%;right:0;min-width:260px;background:var(--card-bg);color:var(--text);border:1px solid var(--card-border);box-shadow:0 12px 30px rgba(0,0,0,.12);border-radius:12px;padding:1rem;backdrop-filter: blur(8px);}
  .dropdown.open .dropdown-content{display:block;}
  .dropdown-content .menu-group{display:flex;flex-direction:column;gap:.6rem;margin-top:.6rem;padding-top:.6rem;border-top:1px dashed var(--card-border);}
  .menu-link{background:none;border:none;text-align:left;color:var(--text);cursor:pointer;padding:.4rem .2rem;border-radius:8px;}
  .menu-link:hover{background:rgba(0,0,0,.06)}
  body.dark .menu-link:hover{background:rgba(255,255,255,.06)}

  .toggle-row{display:flex;align-items:center;justify-content:space-between;gap:.75rem;}
  .toggle-slider{position:relative;width:64px;height:32px;background:#cfd8dc;border-radius:32px;cursor:pointer;transition:background .25s;}
  .toggle-slider::before{content:"";position:absolute;top:3px;left:3px;width:26px;height:26px;background:#fff;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.25);transition:transform .25s;}
  #darkToggle{display:none;}
  #darkToggle:checked + .toggle-slider{background:#4caf50;}
  #darkToggle:checked + .toggle-slider::before{transform: translateX(32px);}

  main{max-width:900px;margin:0 auto;padding:16px;}
  .card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:1.25rem;box-shadow:0 8px 30px rgba(0,0,0,.08);backdrop-filter: blur(10px);}
  .stack{display:flex;flex-direction:column;gap:1rem;}

  /* CHAT */
  #chat-container{display:flex;flex-direction:column;gap:.75rem;max-height:60vh;overflow-y:auto;scroll-behavior:smooth;padding:.25rem .25rem .5rem;border-radius:12px;}
  .qa-pair{display:flex;flex-direction:column;gap:.4rem;margin-bottom:.3rem;}
  .chat-message{display:flex;width:100%;word-break:break-word;}
  .user-message{justify-content:flex-end;}
  .bot-message{justify-content:flex-start;}
  .bubble,.bubble.user{padding:.9rem 1.1rem;border-radius:14px;font-size:1rem;line-height:1.75;box-shadow:0 1px 4px rgba(0,0,0,.05);white-space:pre-wrap;background:var(--bubble-bg);color:var(--bubble-text);max-width:75%;animation:fadeIn .25s ease;}
  .bubble{border-left:4px solid var(--accent-bot);margin:.35rem 0;}
  .bubble.user{background:#c8ebf0;border-right:4px solid var(--accent-user);border-left:0!important;margin:.35rem 0 .35rem auto;max-width:60%;}
  .bubble.user img{max-width:240px;border-radius:10px;margin-top:8px;display:block;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

  /* TIPKANJE ‚Äì sada izvan chata, izmeƒëu chata i forme */
  .typing-wrap{margin-top:-4px;}
  .typing-indicator{font-style:italic;font-size:1rem;padding:.6rem .8rem;color:#333;background:var(--typing-bg);border-left:4px solid var(--typing-border);border-radius:10px;}
  .typing-indicator .dots::after{content:'...';animation:dots 1s steps(3,end) infinite;}
  @keyframes dots{0%{content:''}33%{content:'.'}66%{content:'..'}100%{content:'...'}}

  form{display:flex;flex-direction:column;gap:1rem;} form,textarea,select{autocomplete: off;}
  label{font-weight:600;}
  select{padding:.5rem .6rem;border-radius:8px;border:1px solid var(--card-border);background:#fff;}
  textarea{width:100%;min-height:140px;padding:1rem;font-size:1.08rem;border-radius:12px;border:2px solid #50e3c2;background:#f8fafd;outline:none;resize:vertical;box-shadow:0 2px 8px rgba(0,0,0,.04);}
  textarea:focus{border-color:#3d7d66;box-shadow:0 4px 14px rgba(0,0,0,.08);}
  body.dark select{background:#162024;color:var(--text);}
  body.dark textarea{background:#0f1518;border-color:#2f796a;}

  .file-row{display:flex;flex-direction:column;align-items:flex-start;gap:.55rem;}
  .file-input{display:none;}
  .btn.small{padding:.55rem .8rem;font-size:.95rem;border-radius:9px;}
  .file-chip{display:none;align-items:center;gap:.5rem;background:#eff6ff;border:1px dashed #b9d2ff;color:#2a4365;padding:.35rem .55rem;border-radius:999px;font-size:.88rem;}
  .file-chip .remove{background:transparent;border:none;font-size:1rem;cursor:pointer;color:#2a4365;line-height:1;}
  .file-chip.show{display:inline-flex;}

  .btn{background:var(--btn-bg);color:#fff;border:none;padding:.85rem 1.1rem;font-size:1rem;border-radius:10px;cursor:pointer;width:fit-content;transition: transform .05s ease, background .15s ease;}
  .btn:hover{background:var(--btn-bg-hover);} .btn:active{transform:translateY(1px);}
  .btn.secondary{background:transparent;color:var(--btn-bg);border:2px solid var(--btn-bg);}
  .btn.danger{background:var(--danger);}

  .form-actions{display:flex;align-items:flex-start;justify-content:space-between;gap:1rem;flex-wrap:wrap;padding-top:.75rem;border-top:1px solid var(--card-border);}
  .form-actions .left{display:flex;flex-direction:column;align-items:flex-start;gap:.55rem;flex:1;}
  .form-actions .right{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;}
  @media (max-width:700px){
    .form-actions{flex-direction:column;align-items:stretch;}
    .form-actions .right .btn{width:100%}
  }

  .error-banner{max-width:900px;margin:12px auto 0;background:#ffe9e9;border:1px solid #f3b8b8;color:#7a1e1e;padding:.8rem 1rem;border-radius:10px;}
  body.dark .error-banner{background:#3b1f1f;border-color:#7a3838;color:#ffd7d7;}

  #to-bottom{position:fixed;right:18px;bottom:22px;z-index:1001;display:none;padding:.6rem .8rem;border-radius:12px;font-weight:600;background:var(--btn-bg);color:#fff;border:none;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.18);}
  #to-bottom:hover{background:var(--btn-bg-hover);}

  .muted{color:var(--muted);font-size:.95rem}
  .hidden{display:none}
  .linklike{background:none;border:2px dashed transparent;color:var(--btn-bg);cursor:pointer;text-decoration:underline;padding:.15rem .25rem;border-radius:8px;font-size:.95rem}
  .linklike:hover{border-color:var(--card-border)}
  </style>
</head>
<body>
  <header id="main-header">
    <div class="title-container">MAT-BOT</div>
    <div class="dropdown" id="menuWrap">
      <button class="dropdown-toggle" onclick="toggleDropdown(event)">‚ò∞ Meni</button>
      <div class="dropdown-content">
        <div class="toggle-row">
          <span class="toggle-label">üåô Dark Mode</span>
          <label style="display:flex;align-items:center;gap:.5rem;">
            <input type="checkbox" id="darkToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <!-- Novi meni blokovi -->
        <div class="menu-group">
          <button class="menu-link" id="menu-change-grade">Promijeni razred (i oƒçisti chat)</button>
          <button class="menu-link" id="menu-clear-chat">Oƒçisti chat</button>
        </div>
      </div>
    </div>
  </header>

  {% if error %}<div class="error-banner">{{ error }}</div>{% endif %}

  <main class="stack">
    <!-- CHAT -->
    <div class="card">
      <div id="chat-container">
        {% for message in history %}
        <div class="qa-pair">
          <div class="chat-message user-message"><div class="bubble user"><p>{{ message.user }}</p></div></div>
          <div class="chat-message bot-message"><div class="bubble">{{ message.bot|safe }}</div></div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- INDICATOR izmedju chata i forme -->
    <div id="typing-wrap" class="typing-wrap hidden">
      <div id="typing" class="typing-indicator">
        <span class="dots">ü§ñ MAT-BOT pi≈°e odgovor</span>
      </div>
    </div>

    <!-- FORMA -->
    <div class="card">
      <form id="ask-form" method="POST" enctype="multipart/form-data" autocomplete="off" action="/submit">
        <input type="hidden" name="history_json" id="history_json_main" value='{{ history|tojson|safe }}'>
        <div id="razred-wrapper" {% if razred and not error %}style="display: none;"{% endif %}>
          <label for="razred">Koji si razred?</label>
          <select name="razred" id="razred" required>
            <option value="" disabled {% if not razred %}selected{% endif %}>-- Odaberi razred --</option>
            <option value="5" {% if razred == '5' %}selected{% endif %}>5. razred</option>
            <option value="6" {% if razred == '6' %}selected{% endif %}>6. razred</option>
            <option value="7" {% if razred == '7' %}selected{% endif %}>7. razred</option>
            <option value="8" {% if razred == '8' %}selected{% endif %}>8. razred</option>
            <option value="9" {% if razred == '9' %}selected{% endif %}>9. razred</option>
          </select>
        </div>
        <div id="promijeni-razred-wrap" class="hidden">
          <button type="button" id="promijeni-razred" class="linklike">Promijeni razred</button>
        </div>

        <label for="pitanje">Postavi mi matematiƒçko pitanje (tekst ili slika):</label>
        <textarea name="pitanje" id="pitanje" placeholder="Ovdje mo≈æe≈° unijeti zadatak ili pitanje..." autofocus autocomplete="off"></textarea>

        <div class="form-actions">
          <div class="left">
            <label for="slika">Ili uƒçitaj / uslikaj sliku:</label>
            <div class="file-row">
              <input class="file-input" id="slika" type="file" name="file" accept="image/*" />
              <label for="slika" class="btn secondary small">üìé Izaberi fajl / Kamera</label>
              <span id="file-chip" class="file-chip">
                <span id="file-name">Nije odabran fajl</span>
                <button type="button" class="remove" id="remove-file" title="Ukloni fajl">√ó</button>
              </span>

              <!-- ispod fajla: promijeni razred, zatim oƒçisti -->
              <button type="button" id="btn-change-grade-below" class="linklike">Promijeni razred</button>
              <button type="button" id="btn-clear-chat" class="btn danger small">üóëÔ∏è Oƒçisti chat</button>
            </div>
          </div>

          <div class="right">
            <button id="sendBtn" type="button" class="btn">‚úâÔ∏è Po≈°alji</button>
          </div>
        </div>
      </form>

      <form id="clear-form" method="POST" action="/clear" autocomplete="off">
        <input type="hidden" name="ajax" value="1" />
        <input type="hidden" name="confirm_clear" value="1" />
      </form>
    </div>
  </main>

  <button id="to-bottom" onclick="scrollToBottom()">‚¨á Do dna</button>

<script>
function toggleDropdown(e){ e.preventDefault(); document.getElementById('menuWrap').classList.toggle('open'); }
function initDarkToggle(){
  const cb = document.getElementById('darkToggle');
  const saved = localStorage.getItem('matbot_dark') === '1';
  if (saved){ document.body.classList.add('dark'); cb.checked = true; }
  cb.addEventListener('change', ()=>{ document.body.classList.toggle('dark', cb.checked); localStorage.setItem('matbot_dark', cb.checked ? '1' : '0');});
}

function scrollToBottom(){ const chat=document.getElementById('chat-container'); if(chat) chat.scrollTop = chat.scrollHeight; }

(function setupScrollButton(){
  const chat = document.getElementById('chat-container');
  const btn = document.getElementById('to-bottom');
  if(!chat || !btn) return;
  const toggleBtn = ()=>{ const nearBottom = (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 40; btn.style.display = nearBottom ? 'none' : 'block'; };
  chat.addEventListener('scroll', toggleBtn); setTimeout(toggleBtn, 200);
})();

function getCID(){
  const key='matbot_cid';
  if(!localStorage.getItem(key)){
    const cid = (crypto.randomUUID)? crypto.randomUUID() : (Date.now()+'_'+Math.random());
    localStorage.setItem(key,cid);
  }
  return localStorage.getItem(key);
}
function resetHistory(HIST_KEY, hiddenMain){
  localStorage.removeItem(HIST_KEY);
  if (hiddenMain) hiddenMain.value = '[]';
}
function pushHistory(HIST_KEY, user, bot){
  let arr=[]; try{ arr = JSON.parse(localStorage.getItem(HIST_KEY) || '[]'); }catch(_){}
  arr.push({user, bot}); arr = arr.slice(-8);
  localStorage.setItem(HIST_KEY, JSON.stringify(arr));
  const hidden = document.getElementById('history_json_main');
  if (hidden) hidden.value = JSON.stringify(arr.slice(-5));
}

function updateFileUI(){
  const fileInput = document.getElementById('slika');
  const fileName = document.getElementById('file-name');
  const fileChip  = document.getElementById('file-chip');
  const hasFile = fileInput && fileInput.files && fileInput.files[0];
  if (hasFile){ fileName.textContent = fileInput.files[0].name; fileChip.classList.add('show');}
  else{ fileName.textContent='Nije odabran fajl'; fileChip.classList.remove('show');}
}
function clearFile(){
  const fileInput = document.getElementById('slika'); if (!fileInput) return;
  const dt = new DataTransfer(); fileInput.files = dt.files; fileInput.value = ""; updateFileUI();
}

document.addEventListener('DOMContentLoaded', () => {
  initDarkToggle();

  const askForm   = document.getElementById('ask-form');
  const clearForm = document.getElementById('clear-form');
  const hiddenMain= document.getElementById('history_json_main');
  const fileInput = document.getElementById('slika');
  const removeBtn = document.getElementById('remove-file');
  const textarea  = document.getElementById('pitanje');
  const razredSel = document.getElementById('razred');
  const razredWrap= document.getElementById('razred-wrapper');
  const promijeniWrap = document.getElementById('promijeni-razred-wrap');

  const btnChangeGradeBelow = document.getElementById('btn-change-grade-below');
  const btnClearChat = document.getElementById('btn-clear-chat');
  const menuChangeGrade = document.getElementById('menu-change-grade');
  const menuClearChat = document.getElementById('menu-clear-chat');

  const typingWrap = document.getElementById('typing-wrap');
  const typing = document.getElementById('typing');

  const cid = getCID();
  const HIST_KEY = 'matbot_history_' + cid;
  const serverHistory = {{ history|tojson|safe }};

  if (Array.isArray(serverHistory) && serverHistory.length) {
    const last5 = serverHistory.slice(-5);
    localStorage.setItem(HIST_KEY, JSON.stringify(last5));
    if (hiddenMain) hiddenMain.value = JSON.stringify(last5);
  } else { resetHistory(HIST_KEY, hiddenMain); }

  if (fileInput){ fileInput.addEventListener('change', updateFileUI); }
  if (removeBtn) removeBtn.addEventListener('click', clearFile);

  function ensureChatContainer(){ return document.getElementById('chat-container'); }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // ---------- Typing Manager (sada izmeƒëu chata i forme) ----------
  const TypingManager = (function(){
    let t0 = null, tickTimer = null;
    const stages = [
      {t: 0,   text: "ü§ñ MAT-BOT pi≈°e odgovor", dots:true},
      {t: 8,   text: "‚è≥ Obrada traje mrvicu du≈æe ‚Äì ne ≈°alji upit ponovo", dots:true},
      {t: 20,  text: "üôè Hvala na strpljenju ‚Äî ƒçitam/slikam zadatak", dots:false},
      {t: 40,  text: "‚öôÔ∏è Jo≈° radim‚Ä¶ veliki zadaci znaju potrajati", dots:true},
      {t: 90,  text: "üöÄ Gotovo uskoro‚Ä¶", dots:true},
    ];
    function setText(msg, dots){
      typing.innerHTML = `<span class="${dots?'dots':''}">${msg}</span>`;
    }
    function onTick(){
      const s = Math.floor((Date.now() - t0)/1000);
      let current = stages[0];
      for (const st of stages){ if (s >= st.t) current = st; else break; }
      setText(current.text, current.dots);
    }
    return {
      show(){
        typingWrap.classList.remove('hidden');
        t0 = Date.now(); onTick();
        tickTimer = setInterval(onTick, 1000);
        scrollToBottom();
      },
      hide(){
        typingWrap.classList.add('hidden');
        if (tickTimer){ clearInterval(tickTimer); tickTimer = null; }
      }
    }
  })();

  function showTyping(){ TypingManager.show(); }
  function hideTyping(){ TypingManager.hide(); }

  // --------- UI baloni ---------
  function appendUserPair({text, file}){
    const chat = ensureChatContainer(); if(!chat) return null;
    const pair = document.createElement('div'); pair.className='qa-pair';

    // user bubble
    const u = document.createElement('div'); u.className='chat-message user-message';
    let userHTML = '';
    if (text && text.trim()) userHTML += `<p>${escapeHtml(text)}</p>`;
    if (file){
      try{
        const url = URL.createObjectURL(file);
        userHTML += `<img src="${url}" alt="${escapeHtml(file.name)}" />`;
        setTimeout(()=>URL.revokeObjectURL(url), 60000);
      }catch(_){
        userHTML += `<p><strong>üì∑ ${escapeHtml(file.name)}</strong></p>`;
      }
    }
    if (!userHTML) userHTML = '<p><em>(prazna poruka)</em></p>';
    u.innerHTML = `<div class="bubble user">${userHTML}</div>`;

    pair.appendChild(u);
    chat.appendChild(pair);
    scrollToBottom();
    return pair;
  }
  function appendBotToPair(pair, html){
    if(!pair) return;
    const b = document.createElement('div'); b.className='chat-message bot-message';
    b.innerHTML = `<div class="bubble">${html}</div>`;
    pair.appendChild(b);
    scrollToBottom();
    const bubble = b.querySelector('.bubble');
    if (window.MathJax && MathJax.typesetPromise) { MathJax.typesetPromise([bubble]); }
    applyPlotsIn(bubble);
  }

  function hideGradeAfterFirstSend(){
    if (!razredWrap) return;
    razredWrap.classList.add('hidden');
    razredWrap.style.display = 'none';
    promijeniWrap.classList.remove('hidden');
  }
  function showGradeSelector(){
    razredWrap.classList.remove('hidden');
    razredWrap.style.display = '';
    promijeniWrap.classList.add('hidden');
    if (razredSel) razredSel.focus();
  }

  function clearChatUIAndHistory(){
    const chat = document.getElementById('chat-container');
    if (chat) chat.innerHTML = '';
    const cid = getCID();
    const HIST_KEY = 'matbot_history_' + cid;
    resetHistory(HIST_KEY, document.getElementById('history_json_main'));
    hideTyping();
  }

  // Promijeni razred (dole) + u meniju
  function handleChangeGrade(){
    clearChatUIAndHistory();
    showGradeSelector();
    clearFile();
  }

  [btnChangeGradeBelow, menuChangeGrade].forEach(btn=>{
    if (btn) btn.addEventListener('click', handleChangeGrade);
  });

  // Oƒçisti chat (dole i u meniju)
  function handleClearChat(){
    clearChatUIAndHistory();
  }
  if (btnClearChat) btnClearChat.addEventListener('click', handleClearChat);
  if (menuClearChat) menuClearChat.addEventListener('click', handleClearChat);

  // Slanje
  async function sendOneButton(){
    const f = fileInput?.files?.[0] || null;
    const razred  = razredSel?.value || '';
    const tekst   = textarea?.value?.trim() || '';

    if (!razred){ alert('Odaberi razred.'); return; }
    if (!f && !tekst){ alert('Unesi pitanje ili dodaj sliku.'); return; }

    const userLabel = tekst || (f ? f.name : '');
    hideGradeAfterFirstSend();

    showTyping();
    const pair = appendUserPair({text: tekst, file: f});

    const fd = new FormData();
    fd.append('razred', razred);
    fd.append('user_text', tekst);
    if (f) fd.append('file', f, f.name);

    try{
      const r = await fetch('/submit', { method:'POST', body: fd, credentials:'include' });
      const j = await r.json();

      // SYNC (200)
      if (r.status === 200 && j && j.result && j.result.html){
        appendBotToPair(pair, j.result.html);
        pushHistory('matbot_history_'+getCID(), userLabel, j.result.html);
        hideTyping();
        textarea.value = ''; clearFile();
        return;
      }

      // ASYNC (202)
      if (r.status === 202 && j && j.job_id){
        textarea.value = ''; clearFile();
        await poll(j.job_id, userLabel, pair);
        return;
      }

      appendBotToPair(pair, '<div class="alert alert-danger">Neoƒçekivan odgovor servera.</div>');
      hideTyping();
    }catch(_){
      appendBotToPair(pair, 'Gre≈°ka pri slanju zahtjeva.');
      hideTyping();
    }
  }

  async function poll(jobId, userLabel, pair){
    const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
    for (let i=0;i<180;i++){
      await sleep(2000);
      try{
        const r = await fetch(`/status/${jobId}`, {cache:'no-store', credentials:'include'});
        if (!r.ok) throw new Error('status http '+r.status);
        const data = await r.json();
        if (data.status === 'done'){
          const html = (data.result && data.result.html) || '<i>Nema rezultata.</i>';
          appendBotToPair(pair, html);
          pushHistory('matbot_history_'+getCID(), userLabel, html);
          hideTyping();
          return;
        }
        if (data.status === 'error'){
          appendBotToPair(pair, `<div class="alert alert-danger">Gre≈°ka: ${escapeHtml(data.error || 'nepoznato')}</div>`);
          hideTyping(); return;
        }
      }catch(_){
        appendBotToPair(pair, '<div class="alert alert-danger">Gre≈°ka pri provjeri statusa.</div>');
        hideTyping(); return;
      }
    }
    appendBotToPair(pair, '<div class="alert alert-warning">Istek vremena ƒçekanja na rezultat.</div>');
    hideTyping();
  }

  document.getElementById('sendBtn')?.addEventListener('click', sendOneButton);
  askForm?.addEventListener('submit', (e)=>{ e.preventDefault(); sendOneButton(); });

  // ‚ÄúOƒçisti chat‚Äù (server-side opcionalno) ‚Äì frontend svakako ƒçisti odmah
  if (clearForm){
    clearForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      try{ await fetch(clearForm.action || '/clear', { method:'POST', body: new FormData(clearForm), credentials:'include' }); }
      catch(_){}
      handleClearChat();
      showGradeSelector();
    });
  }

  // meni ‚Äì dodatno, zatvori nakon klika
  [menuChangeGrade, menuClearChat].forEach(btn=>{
    if (btn) btn.addEventListener('click', ()=>document.getElementById('menuWrap').classList.remove('open'));
  });
});

window.onload = ()=> setTimeout(scrollToBottom, 150);

// ------- Plot helpers -------
function transformExpression(expr){
  return expr.replace(/\s+/g,'')
    .replace(/([0-9])([a-zA-Z])/g,'$1*$2')
    .replace(/([a-zA-Z])([a-zA-Z])/g,'$1*$2')
    .replace(/([a-zA-Z])(\d)/g,'$1*$2')
    .replace(/(\))(\()/g,'$1*$2')
    .replace(/(\))([a-zA-Z])/g,'$1*$2')
    .replace(/([a-zA-Z])(\()/g,'$1*$2')
    .replace(/(\d+|\w+)\^(\d+|\w+)/g,'Math.pow($1,$2)')
    .replace(/(?<!\.)\b(sin|cos|tan|exp|log|sqrt|abs)\b/g,'Math.$1')
    .replace(/\bln\b/g,'Math.log');
}
function drawPlot(expression, container){
  const parsed = transformExpression(expression);
  const x=[], y=[]; let f;
  try{ f=new Function('x',`return ${parsed}`); }catch(e){ return; }
  for(let i=-10;i<=10;i+=0.1){
    try{ const res=f(i); x.push(i); y.push(isFinite(res)?res:null);}catch{ x.push(i); y.push(null);}
  }
  const data=[{x,y,mode:'lines',line:{color:'#0077cc',width:3},name:expression}];
  const layout={title:`Graf funkcije: y = ${expression}`,xaxis:{title:'x'},yaxis:{title:'y'},margin:{t:40},plot_bgcolor:'#fff',paper_bgcolor:'#fff'};
  const graphDiv=document.createElement("div");
  graphDiv.style="width:100%;max-width:700px;height:400px;margin-top:1rem;";
  container.appendChild(graphDiv);
  Plotly.newPlot(graphDiv,data,layout);
}
function applyPlotsIn(root){
  root.querySelectorAll('.plot-request').forEach(plotDiv=>{
    let expression=plotDiv.getAttribute("data-expression");
    const parent=plotDiv.closest(".bubble") || root;
    if(!expression||!parent) return;
    if(expression.trim().startsWith("y=")) expression=expression.replace(/^y\s*=\s*/i,"").trim();
    drawPlot(expression,parent);
    plotDiv.remove();
  });
}
document.querySelectorAll('.plot-request').forEach(plotDiv=>{
  const parent=plotDiv.closest(".bubble") || document.body;
  let expression=plotDiv.getAttribute("data-expression")||'';
  if(expression.trim().startsWith("y=")) expression=expression.replace(/^y\s*=\s*/i,"").trim();
  drawPlot(expression,parent);
  plotDiv.remove();
});
</script>
</body>
</html>
